#include <proto/graphics.h>
#include <proto/exec.h>
#include <intuition/intuitionbase.h>
#include <intuition/screens.h>
#include <graphics/view.h>

void main(void)
{
  struct IntuitionBase * IntuitionBase;
  struct Library * GfxBase;
  struct ViewPort * vp;
  struct ColorMap * cm;
  struct PaletteExtra * pe;
#define NUMCOLORS 32
  ULONG n[2*NUMCOLORS];
  ULONG i;

  IntuitionBase = (struct IntuitionBase *)OpenLibrary("intuition.library",0);
  GfxBase = OpenLibrary("graphics.library",0);

  cm = GetColorMap(NUMCOLORS);

  vp = &IntuitionBase->ActiveScreen->ViewPort;
  
  AttachPalExtra(cm,vp);
  pe = cm->PalExtra;
  
  n[0]  = ObtainPen(cm, 
                    -1, 
                    0xa0000000,
                    0xb0000000,
                    0xc0000000,
                    0);
            
  printf("Got pen number %i.\n",n[0]);
  
  printf("Trying to obtain the same pen as shared.\n");
  n[1]  = ObtainPen(cm, 
                    -1, 
                    0xa0000000,
                    0xb0000000,
                    0xc0000000,
                    0);
  
  printf("Got pen number %i (=%i!).\n",n[1],n[0]);
  
  printf("Trying to obtain a pen as exclusive.\n");
  n[2]  = ObtainPen(cm, 
                    -1, 
                    0xa0000000,
                    0xb0000000,
                    0xc0000000,
                    PENF_EXCLUSIVE);
    
  printf("Got pen number %i.\n",n[2]);

  printf("Trying to allocate pen %i as exclusive again.\n",n[2]);  
  n[3]  = ObtainPen(cm, 
                    n[2], 
                    0xa0000000,
                    0xb0000000,
                    0xc0000000,
                    PENF_EXCLUSIVE);
    
  printf("Got pen number %i.\n",n[3]);

  printf("Trying to allocate pen %i as shared.\n",n[2]);  
  n[4]  = ObtainPen(cm, 
                    n[2], 
                    0xa0000000,
                    0xb0000000,
                    0xc0000000,
                    0);
    
  printf("Got pen number %i.\n",n[4]);

  printf("Releasing all pens.\n");
  ReleasePen(cm, n[4]);
  ReleasePen(cm, n[3]);
  ReleasePen(cm, n[2]);
  ReleasePen(cm, n[1]);
  ReleasePen(cm, n[0]);

  printf("Obtaining a shared pen.\n");
  n[0]  = ObtainPen(cm, 
                    -1, 
                    0xa0000000,
                    0xb0000000,
                    0xc0000000,
                    0);
            
  printf("Got pen number %i.\n",n[0]);
  
  ReleasePen(cm, n[0]);

  printf("---------------------------\n");

  printf("Trying to allocate %i shared pens\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i] = ObtainPen(cm, -1, i << 28, i << 24, i << 20,0);
    
    printf("Got pen %i\n",n[i]);
    i++;
  }

  printf("Trying to get %i exclusive pens (no pen was released)\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i+NUMCOLORS] = ObtainPen(cm, -1, 0,0,0,PENF_EXCLUSIVE);
    
    printf("Got pen %i (=-1)\n",n[i+NUMCOLORS]);
    i++;
  }
 
  printf("Releasing all pens!\n");
  i = 0;
  while (i < 2 * NUMCOLORS)
  {
    ReleasePen(cm, n[i]);
    i++;
  }

  printf("---------------------------\n");

  
  printf("Trying to get %i exclusive pens\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i] = ObtainPen(cm, -1, 0,0,0,PENF_EXCLUSIVE);
    
    printf("Got pen %i\n",n[i]);
    i++;
  }

  printf("Trying to allocate %i shared pens (no pen was released)\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i+NUMCOLORS] = ObtainPen(cm, -1, 0,0,0,0);
    
    printf("Got pen %i (=-1)\n",n[i+NUMCOLORS]);
    i++;
  }
 
  printf("Releasing all pens!\n");
  i = 0;
  while (i < 2*NUMCOLORS)
  {
    ReleasePen(cm, n[i]);
    i++;
  }

  printf("---------------------------\n");

  printf("Trying to allocate %i shared pens at certain indices\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i] = ObtainPen(cm, i, 0, 0, 0,0);
    
    printf("Got pen %i\n",n[i]);
    i++;
  }

  printf("Trying to get %i exclusive pens (no pen was released)\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i+NUMCOLORS] = ObtainPen(cm, -1, 0,0,0,PENF_EXCLUSIVE);
    
    printf("Got pen %i (=-1)\n",n[i+NUMCOLORS]);
    i++;
  }
 
  printf("Releasing all pens!\n");
  i = 0;
  while (i < 2 * NUMCOLORS)
  {
    ReleasePen(cm, n[i]);
    i++;
  }
  
  printf("---------------------------\n");

  printf("Trying to get %i exclusive pens at certain indices\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i] = ObtainPen(cm, i, 0,0,0,PENF_EXCLUSIVE);
    
    printf("Got pen %i\n",n[i]);
    i++;
  }

  printf("Trying to allocate %i shared pens (bo pen was released)\n",NUMCOLORS);
  i = 0;
  while (i < NUMCOLORS)
  {
    n[i+NUMCOLORS] = ObtainPen(cm, -1, 0,0,0,0);
    
    printf("Got pen %i (=-1)\n",n[i+NUMCOLORS]);
    i++;
  }
 
  printf("Releasing all pens!\n");
  i = 0;
  while (i < 2*NUMCOLORS)
  {
    ReleasePen(cm, n[i]);
    i++;
  }
  
  printf("---------------------------\n");
  
  FreeColorMap(cm);
}
