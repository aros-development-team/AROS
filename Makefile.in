# Main makefile for AROS
# Copyright (C) 2000 AROS - The Amiga Research OS
#
# $Id$
default: all

AROS_HOST_CPU    ?= @aros_host_cpu@
AROS_HOST_ARCH   ?= @aros_host_arch@
AROS_TARGET_CPU  ?= @aros_target_cpu@
AROS_TARGET_ARCH ?= @aros_target_arch@

TOP := $(shell pwd)
include $(TOP)/config/make.cfg

all: makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.AROS

makedirs:
	@$(RM) $(TOP)/errors
	@$(FOR) dir in $(AROSDIR) $(GENDIR) $(TOOLDIR) ; do \
	    $(IF) [ ! -d $$dir ]; then \
		$(MECHO) $(MKDIR) "$$dir" ; \
		$(MKDIR) "$$dir" ; \
	    else true ; fi ; \
	done
	@$(IF) [ ! -f $(AROSDIR)/.gdbinit ]; then \
	    $(CP) $(TOP)/_gdbinit $(AROSDIR)/.gdbinit ; \
	else true ; fi

# Create the tools that are used to build AROS.
tools : makedirs $(TOOLLIB) $(GENMF) $(CPAK) $(ARCHTOOL) \
	$(FLEXCAT) $(GENSKELETON) $(CREATEDTDESC) $(ILBMTOC) \
	$(COLLECT-AROS) $(ADFLIB) $(CREATEHDFILE) \
	$(MKFSAFFS)

$(TOOLLIB) : $(wildcard $(TOP)/tools/toollib/*.[ch])
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/toollib TOP=$(TOP)

$(GENMF) : $(TOP)/tools/genmf/genmf.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/genmf TOP=$(TOP)

$(CPAK) : $(TOP)/tools/cpak/cpak.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/cpak TOP=$(TOP)

$(ARCHTOOL) : $(TOP)/tools/archtools/archtool.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/archtools TOP=$(TOP)

$(FLEXCAT) : $(TOP)/tools/FlexCat/flexcat.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/FlexCat TOP=$(TOP)

$(GENSKELETON) : $(TOP)/tools/genskeleton/genskeleton.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/genskeleton TOP=$(TOP)

$(CREATEDTDESC) : $(wildcard $(TOP)/tools/dtdesc/*.[ch]) $(wildcard $(TOP)/tools/dtdesc/c_iff/*.[ch])
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/dtdesc -f Makefile.aros TOP=$(TOP)

$(ADFLIB) : $(wildcard $(TOP)/tools/adflib/*.[ch])
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/adflib -f Makefile.aros TOP=$(TOP)

$(CREATEHDFILE) : $(TOP)/tools/disktool/createhdfile.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/disktool TOP=$(TOP)

$(MKFSAFFS) : $(TOP)/tools/mkfsaffs/mkfsaffs.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/mkfsaffs TOP=$(TOP)

$(ILBMTOC) : $(TOP)/tools/ilbmtoc/ilbmtoc.c
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/ilbmtoc TOP=$(TOP)

$(COLLECT-AROS) : $(wildcard $(TOP)/tools/collect-aros/*.[hc])
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/collect-aros TOP=$(TOP)

# MetaMake apparently requires a slighty different compilation. Probably
# because it is sort-of an external package as well.

mmake : $(TOP)/tools/MetaMake/Makefile $(MMAKE)

$(TOP)/tools/MetaMake/configure : $(TOP)/tools/MetaMake/configure.in
	cd $(TOP)/tools/MetaMake ; aclocal ; autoconf

$(TOP)/tools/MetaMake/Makefile.in : $(TOP)/tools/MetaMake/Makefile.am
	cd $(TOP)/tools/MetaMake ; automake

$(TOP)/tools/MetaMake/Makefile : $(TOP)/tools/MetaMake/configure \
		$(TOP)/tools/MetaMake/Makefile.in
	cd $(TOP)/tools/MetaMake ; ./configure --prefix=$(TOOLDIR)

$(MMAKE): $(TOP)/tools/MetaMake/mmake.c $(GENMF)
	$(MAKE) $(MKARGS) -C $(TOP)/tools/MetaMake
	cp $(TOP)/tools/MetaMake/mmake$(HOST_EXE_SUFFIX) $(MMAKE)

# Clean the sources
clean:
	@$(CALL) $(MMAKE) AROS.clean
	-@$(RM) $(ARCHDIR) Makefile mmake.cache config.cache config.status \
	    config.log

# Clean the sources and tools
arch-clean: clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/MetaMake clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/FlexCat clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/archtools clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/cpak clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/genmf clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/toollib clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/genskeleton clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/dtdesc -f Makefile.aros clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/collect-aros clean
        
# Really clean all - like a clean checkout
dist-clean: arch-clean
	@$(RM) Makefile configure config.* mmake.cache mmake.config

# Dependencies don't work with .DEFAULT :-(
docs : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.docs

all-docs : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.all-docs

install : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.install

# Don't try to generate $(TOP)/bin/$(AROS_TARGET_ARCH)-$(TARGET_CPU)/gen/config/make.opts
$(TOP)/bin/$(AROS_TARGET_ARCH)-$(TARGET_CPU)/gen/config/make.opts:
	@$(NOP)

# targets which do not generate files or for which a file/directory exists
.PHONY: default all makedirs tools docs clean arch-clean dist-clean install \
	$(TOP)/bin/$(AROS_TARGET_ARCH)-$(TARGET_CPU)/gen/config/make.opts test \
	test workbench rom compiler contrib

# Map MetaTargets to make targets : Call mmake with AROS.target
# This does not allow to check for dependancies, so it is not suitable for
# Calling standard main targets, but is usable as a shortcut for MetaMake
# if it was not installed globally
.DEFAULT :
	@$(CALL) $(MMAKE) AROS.$@

