# Copyright © 2000-2003, The AROS Development Team. All rights reserved.
# $Id$
#
# Main makefile for AROS

default: all

AROS_HOST_CPU       ?= @aros_host_cpu@
AROS_HOST_ARCH      ?= @aros_host_arch@
AROS_TARGET_CPU     ?= @aros_target_cpu@
AROS_TARGET_ARCH    ?= @aros_target_arch@
AROS_TARGET_VARIANT ?= @aros_target_variant@

TOP := $(shell pwd)
include $(TOP)/config/make.cfg

all: makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.AROS

makedirs:
	@$(RM) $(TOP)/errors
	@$(FOR) dir in $(AROSDIR) $(GENDIR) $(TOOLDIR) ; do \
	    $(IF) [ ! -d $$dir ]; then \
		$(MECHO) $(MKDIR) "$$dir" ; \
		$(MKDIR) "$$dir" ; \
	    else true ; fi ; \
	done
	@$(IF) [ ! -f $(AROSDIR)/.gdbinit ]; then \
	    $(CP) $(TOP)/_gdbinit $(AROSDIR)/.gdbinit ; \
	else true ; fi

# Create the tools that are used to build AROS.
tools : makedirs $(TOOLLIB) $(GENMF) $(ARCHTOOL) \
	$(FLEXCAT) $(CREATEDTDESC) $(ILBMTOC) $(ILBMTOICON) \
	$(COLLECT-AROS) $(AFSLIB) $(COPYTOAFS) \
	$(FD2INLINE) $(FD2PRAGMA) $(SFDC)

$(TOOLLIB) : $(wildcard $(TOP)/tools/toollib/*.[ch])
	@$(ECHO) Building toollib...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/toollib TOP=$(TOP)

$(GENMF) : $(TOP)/tools/genmf/genmf.py
	@$(ECHO) Copying genmf...
	@./config.status $(subst $(TOP)/,,$(GENMF)) genmf_executable

$(ARCHTOOL) : $(TOP)/tools/archtools/archtool.c
	@$(ECHO) Building archtool...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/archtools TOP=$(TOP)

$(FLEXCAT) : $(TOP)/tools/FlexCat/flexcat.c
	@$(ECHO) Building flexcat...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/FlexCat TOP=$(TOP)

$(CREATEDTDESC) : $(wildcard $(TOP)/tools/dtdesc/*.[ch]) $(wildcard $(TOP)/tools/dtdesc/c_iff/*.[ch])
	@$(ECHO) Building createdtdesc...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/dtdesc -f Makefile.aros TOP=$(TOP)

$(AFSLIB) : $(wildcard $(TOP)/workbench/devs/afs/*.[ch])
	@$(ECHO) Building afslib...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/copytoafs -f Makefile.afslib TOP=$(TOP)

$(COPYTOAFS) : $(TOP)/tools/copytoafs/copytoafs.c
	@$(ECHO) Building copytoafs...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/copytoafs TOP=$(TOP)

$(ILBMTOC) : $(TOP)/tools/ilbmtoc/ilbmtoc.c
	@$(ECHO) Building ilbmtoc...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/ilbmtoc TOP=$(TOP)

$(ILBMTOICON) : $(TOP)/tools/ilbmtoicon/ilbmtoicon.c
	@$(ECHO) Building ilbmtoicon...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/ilbmtoicon TOP=$(TOP)

$(COLLECT-AROS) : $(wildcard $(TOP)/tools/collect-aros/*.[hc])
	@$(ECHO) Building collect-aros...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/collect-aros TOP=$(TOP)

$(FD2INLINE) : $(TOP)/tools/fd2inline/fd2inline.c
	@$(ECHO) Building fd2inline...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/fd2inline TOP=$(TOP)

$(FD2PRAGMA) : $(TOP)/tools/fd2pragma/fd2pragma.c
	@$(ECHO) Building fd2pragma...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/fd2pragma TOP=$(TOP)

$(SFDC) : $(TOP)/tools/sfdc/*.pl 
	@$(ECHO) Building sfdc...
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/sfdc TOP=$(TOP)

# MetaMake apparently requires a slighty different compilation. Probably
# because it is sort-of an external package as well.

mmake : $(TOP)/tools/MetaMake/Makefile $(MMAKE)

$(TOP)/tools/MetaMake/configure : $(TOP)/tools/MetaMake/configure.in
	@$(ECHO) Building MetaMake...
	@cd $(TOP)/tools/MetaMake ; @aros_host_aclocal@ ; @aros_host_autoconf@

$(TOP)/tools/MetaMake/Makefile.in : $(TOP)/tools/MetaMake/Makefile.am
	@cd $(TOP)/tools/MetaMake ; @aros_host_automake@ -a -c

$(TOP)/tools/MetaMake/Makefile : $(TOP)/tools/MetaMake/configure \
	$(TOP)/tools/MetaMake/Makefile.in
	@cd $(TOP)/tools/MetaMake ; CC="$(HOST_CC)" CFLAGS= ./configure --prefix=$(TOOLDIR)

$(MMAKE): $(wildcard $(TOP)/tools/MetaMake/*.[ch]) $(GENMF)
	@$(MAKE) $(MKARGS) AUTOHEADER=@aros_host_autoheader@ -C $(TOP)/tools/MetaMake
	@cp $(TOP)/tools/MetaMake/mmake$(HOST_EXE_SUFFIX) $(MMAKE)

# Clean the sources
clean:
	@$(CALL) $(MMAKE) AROS.clean
	-@$(RM) $(ARCHDIR) Makefile mmake.cache config.cache config.status \
	    config.log

# Clean the sources and tools
arch-clean: clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/MetaMake clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/FlexCat clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/archtools clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/genmf clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/toollib clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/genskeleton clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/dtdesc -f Makefile.aros clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/collect-aros clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/fd2inline clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/fd2pragma clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(TOP)/tools/sfdc clean
        
# Really clean all - like a clean checkout
dist-clean: arch-clean
	@$(RM) Makefile configure config.* mmake.cache mmake.config

# Dependencies don't work with .DEFAULT :-(
docs : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.docs

all-docs : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.all-docs

sdk : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.sdk

install : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.install

# Don't try to generate $(TOP)/bin/$(AROS_TARGET_ARCH)-$(AROS_TARGET_CPU)$(AROS_TARGET_SUFFIX)/gen/config/make.opts
$(TOP)/bin/$(AROS_TARGET_ARCH)-$(AROS_TARGET_CPU)$(AROS_TARGET_SUFFIX)/gen/config/make.opts:
	@$(NOP)

# targets which do not generate files or for which a file/directory exists
.PHONY: default all makedirs tools docs clean arch-clean dist-clean install \
	$(TOP)/bin/$(AROS_TARGET_ARCH)-$(AROS_TARGET_CPU)$(AROS_TARGET_SUFFIX)/gen/config/make.opts test \
	kernel workbench rom compiler contrib sdk

# Map MetaTargets to make targets : Call mmake with AROS.target
# This does not allow to check for dependancies, so it is not suitable for
# Calling standard main targets, but is usable as a shortcut for MetaMake
# if it was not installed globally
.DEFAULT :
	@$(CALL) $(MMAKE) AROS.$@

