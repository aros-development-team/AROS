# Copyright © 2000-2003, The AROS Development Team. All rights reserved.
# $Id$
#
# Main makefile for AROS

default: all

AROS_HOST_CPU       ?= @aros_host_cpu@
AROS_HOST_ARCH      ?= @aros_host_arch@
AROS_TARGET_CPU     ?= @aros_target_cpu@
AROS_TARGET_ARCH    ?= @aros_target_arch@
AROS_TARGET_VARIANT ?= @aros_target_variant@

# normally, these variable's should go in mmake.config/globalvarfile
export AROS_TARGET_BOOTLOADER := @aros_target_bootloader@
export AROS_GUI_THEME := @aros_target_guitheme@

TOP := @AROS_BUILDDIR@
AROS_SRC := @AROS_SRCDIR@
include $(TOP)/config/make.cfg

all: makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.AROS

makedirs:
	@$(RM) $(TOP)/errors
	@$(FOR) dir in $(AROSDIR) $(GENDIR) $(TOOLDIR) ; do \
	    $(IF) [ ! -d $$dir ]; then \
		$(MECHO) $(MKDIR) "$$dir" ; \
		$(MKDIR) "$$dir" ; \
	    else true ; fi ; \
	done
	@$(IF) [ ! -f $(AROSDIR)/.gdbinit ]; then \
	    $(CP) $(AROS_SRC)/_gdbinit $(AROSDIR)/.gdbinit ; \
	else true ; fi

# Create the tools that are used to build AROS.
tools : makedirs $(TOOLLIB) $(GENMF) $(ARCHTOOL) \
	$(FLEXCAT) $(CREATEDTDESC) $(ILBMTOC) $(ILBMTOICON) \
	$(COLLECT-AROS) $(AFSLIB) $(COPYTOAFS) \
	$(FD2INLINE) $(FD2PRAGMA) $(SFDC)

$(TOOLLIB) : $(wildcard $(AROS_SRC)/tools/toollib/*.[ch])
	@$(ECHO) Building toollib...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/toollib AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(GENMF) : $(AROS_SRC)/tools/genmf/genmf.py
	@$(ECHO) Copying genmf...
	@./config.status $(subst $(TOP)/,,$(GENMF)) genmf_executable

$(ARCHTOOL) : $(AROS_SRC)/tools/archtools/archtool.c
	@$(ECHO) Building archtool...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/archtools AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(FLEXCAT) : $(AROS_SRC)/tools/FlexCat/flexcat.c
	@$(ECHO) Building flexcat...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/FlexCat AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(CREATEDTDESC) : $(wildcard $(AROS_SRC)/tools/dtdesc/*.[ch]) $(wildcard $(AROS_SRC)/tools/dtdesc/c_iff/*.[ch])
	@$(ECHO) Building createdtdesc...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/dtdesc -f Makefile.aros AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(AFSLIB) : $(wildcard $(AROS_SRC)/workbench/devs/afs/*.[ch])
	@$(ECHO) Building afslib...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/copytoafs -f Makefile.afslib AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(COPYTOAFS) : $(AFSLIB) $(AROS_SRC)/tools/copytoafs/copytoafs.c
	@$(ECHO) Building copytoafs...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/copytoafs AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(ILBMTOC) : $(AROS_SRC)/tools/ilbmtoc/ilbmtoc.c
	@$(ECHO) Building ilbmtoc...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/ilbmtoc AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(ILBMTOICON) : $(AROS_SRC)/tools/ilbmtoicon/ilbmtoicon.c
	@$(ECHO) Building ilbmtoicon...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/ilbmtoicon AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(COLLECT-AROS) : $(wildcard $(AROS_SRC)/tools/collect-aros/*.[hc])
	@$(ECHO) Building collect-aros...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/collect-aros AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(FD2INLINE) : $(AROS_SRC)/tools/fd2inline/fd2inline.c
	@$(ECHO) Building fd2inline...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/fd2inline AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(FD2PRAGMA) : $(AROS_SRC)/tools/fd2pragma/fd2pragma.c
	@$(ECHO) Building fd2pragma...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/fd2pragma AROS_SRC=$(AROS_SRC) TOP=$(TOP)

$(SFDC) : $(AROS_SRC)/tools/sfdc/*.pl 
	@$(ECHO) Building sfdc...
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/sfdc AROS_SRC=$(AROS_SRC) TOP=$(TOP)

# MetaMake apparently requires a slighty different compilation. Probably
# because it is sort-of an external package as well.

mmake : $(TOP)/tools/MetaMake/Makefile $(MMAKE)

$(AROS_SRC)/tools/MetaMake/configure : $(AROS_SRC)/tools/MetaMake/configure.in
	@$(ECHO) Building MetaMake...
	@cd $(AROS_SRC)/tools/MetaMake ; @aros_host_aclocal@ ; @aros_host_autoconf@

$(TOP)/tools/MetaMake/Makefile : $(AROS_SRC)/tools/MetaMake/configure $(AROS_SRC)/tools/MetaMake/Makefile.in
	@$(IF) [ ! -d $(TOP)/tools/MetaMake ]; then \
	    $(MECHO) $(MKDIR) "$(TOP)/tools/MetaMake" ; \
	    $(MKDIR) "$(TOP)/tools/MetaMake"; \
	fi;
	@cd $(TOP)/tools/MetaMake ; CC="$(HOST_CC)" CFLAGS= $(AROS_SRC)/tools/MetaMake/configure --prefix=$(TOOLDIR) --bindir=$(TOOLDIR) --with-objfiledir=$(HOSTGENDIR)/tools/MetaMake

$(MMAKE): $(wildcard $(AROS_SRC)/tools/MetaMake/*.[ch]) $(GENMF)
	@$(MAKE) $(MKARGS) AUTOHEADER=@aros_host_autoheader@ -C $(TOP)/tools/MetaMake
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/MetaMake install

# Clean the sources and tools
clean:
	@$(CALL) $(MMAKE) AROS.clean
	@$(MAKE) $(MKARGS) -C $(TOP)/tools/MetaMake clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/FlexCat clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/archtools clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/genmf clean
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/toollib clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/dtdesc -f Makefile.aros clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/collect-aros clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/fd2inline clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/fd2pragma clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	@$(CALL) $(MAKE) $(MKARGS) -C $(AROS_SRC)/tools/sfdc clean AROS_SRC=$(AROS_SRC) TOP=$(TOP)
	-@$(RM) $(ARCHDIR) Makefile config.cache config.status config.log mmake.cache mmake.config rom/mmakefile config/make.cfg $(AROS_DEVELOPMENT)/include/aros/config.h $(GENDIR)/include/aros/config.h $(HOSTGENDIR)/config/host.cfg $(GENDIR)/config/target.cfg $(GENDIR)/config/make.defaults $(GENDIR)/config/specs $(TOOLDIR)/$(AROS_TARGET_CPU)-$(AROS_TARGET_ARCH)$(AROS_TARGET_SUFFIX)-aros-gcc $(TOOLDIR)/$(AROS_TARGET_CPU)-$(AROS_TARGET_ARCH)$(AROS_TARGET_SUFFIX)-aros-ld $(GENDIR)/scripts/genshared $(TOOLDIR)/genmf.py tools/adflib/myconf.aros tools/collect-aros/env.h

# Clean the sources and tools
arch-clean: clean
	@$(NOP)

# Really clean all - like a clean checkout
dist-clean: arch-clean
	@$(NOP)

# Dependencies don't work with .DEFAULT :-(
docs : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.docs

all-docs : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.all-docs

sdk : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.sdk

install : makedirs tools mmake
	@$(CALL) $(MMAKE) AROS.install

# Don't try to generate $(TOP)/bin/$(AROS_TARGET_ARCH)-$(AROS_TARGET_CPU)$(AROS_TARGET_SUFFIX)/gen/config/make.opts
$(TOP)/bin/$(AROS_TARGET_ARCH)-$(AROS_TARGET_CPU)$(AROS_TARGET_SUFFIX)/gen/config/make.opts:
	@$(NOP)

# targets which do not generate files or for which a file/directory exists
.PHONY: default all makedirs tools docs clean arch-clean dist-clean install \
	$(TOP)/bin/$(AROS_TARGET_ARCH)-$(AROS_TARGET_CPU)$(AROS_TARGET_SUFFIX)/gen/config/make.opts test \
	kernel workbench rom compiler contrib sdk mmake

# Workaround for bug in make v3.81 (should normally be handled by .DEFAULT)
test kernel workbench rom compiler contrib :
	@$(CALL) $(MMAKE) AROS.$@

# Map MetaTargets to make targets : Call mmake with AROS.target
# This does not allow to check for dependancies, so it is not suitable for
# Calling standard main targets, but is usable as a shortcut for MetaMake
# if it was not installed globally
.DEFAULT :
	@$(CALL) $(MMAKE) AROS.$@

