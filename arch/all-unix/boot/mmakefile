include $(TOP)/config/make.cfg

ifeq ($(AROS_TARGET_VARIANT),)
    BSP := $(ARCH)
else
    BSP := $(AROS_TARGET_VARIANT)
endif

# -------- Bootstrap part --------

#MM boot-unix: kernel-bootstrap-hosted

#MM
boot-unix: $(BINDIR)/boot/AROSBootstrap.conf

$(BINDIR)/boot/AROSBootstrap.conf: mkbootconf.sh $(BINDIR)/boot AROSBootstrap.conf
	@$(ECHO) Writing $@...
	@$(SRCDIR)/$(CURDIR)/mkbootconf.sh $(SRCDIR)/$(CURDIR) $(BSP) >$@

$(BINDIR)/boot:
	@$(ECHO) Making $@...
	@mkdir -p $(BINDIR)/boot

# -------- Kickstart part --------

#MM- kernel-unix: kernel-link-base kernel-link-hosted kernel-timer

#MM- kernel-link-unix : \
#MM	kernel-kernel-kobj			\
#MM     kernel-hostlib-kobj			\
#MM	kernel-battclock-kobj			\
#MM	kernel-processor-kobj			\
#MM	kernel-expansion-kobj			\
#MM	kernel-exec-kobj			\
#MM     $(X11_HIDD_TARGET)		        \
#MM     kernel-fs-emul-kobj                     \
#MM	linklibs				\
#MM	kernel-link-unix-quick

#MM
kernel-link-unix-quick : $(BINDIR)/boot/aros-bsp-$(BSP)

# UNIX board support package
KLIBS   := exec expansion
KDEVS   :=
KHNDLRS := emul
KHIDDS  := 
KRSRCS  := kernel battclock hostlib processor
# Disabled until ported - sonic
# ifeq ("$(AROS_HOST_ARCH)","linux")
# KHIDDS  += linux
# endif
ifeq ("$(X11_HIDD_TARGET)", "kernel-x11gfx-kobj")
    KHIDDS += x11gfx
endif

# Module containing startup code (kernel.resource) must appear
# in the beginning of the final list
KOBJS := $(addprefix $(KOBJSDIR)/,$(addsuffix _resource.o,$(KRSRCS) )) \
	 $(addprefix $(KOBJSDIR)/,$(addsuffix _library.o ,$(KLIBS)  )) \
      	 $(addprefix $(KOBJSDIR)/,$(addsuffix _device.o  ,$(KDEVS)  )) \
      	 $(addprefix $(KOBJSDIR)/,$(addsuffix _handler.o ,$(KHNDLRS))) \
      	 $(addprefix $(KOBJSDIR)/,$(addsuffix _hidd.o    ,$(KHIDDS) ))

DEP_LIBS := \
	$(LIBDIR)/libamiga.a \
	$(LIBDIR)/libarossupport.a \
	$(LIBDIR)/libhiddgraphicsstubs.a \
	$(LIBDIR)/libhiddstubs.a \
	$(LIBDIR)/libautoinit.a \
	$(LIBDIR)/liblibinit.a

LIBS :=	-larossupport -lhiddgraphicsstubs -lhiddstubs -lamiga -lautoinit -llibinit -lrom -lm

$(BINDIR)/boot/aros-bsp-$(BSP): $(DEP_LIBS) $(KOBJS) $(BINDIR)/boot
	@$(ECHO) Linking $@...
	@$(TARGET_CC) $(KOBJS) $(LIBS) -o $@ $(CONFIG_LDFLAGS) $(NOSTARTUP_LDFLAGS)
