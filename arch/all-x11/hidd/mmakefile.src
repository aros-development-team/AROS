# $Id$
include $(TOP)/config/make.cfg

# This library contains only one function,
# which is private (no protos should be generated).
# and there doesn't seem to be a template for handling thiscase
# so I write the file manually.

ifdef GUI_INCDIR
USER_INCLUDES := -I. -I$(GUI_INCDIR)
XSHM_INCLUDES := -I$(SYS_INCLUDES) -I$(GUI_INCDIR)
else
USER_INCLUDES := -I.
XSHM_INCLUDES := -I$(SYS_INCLUDES)
endif

USER_INCLUDES := $(USER_INCLUDES) -I$(SYS_INCLUDES)

OS_INCLUDES := -I$(GENINCDIR)

CFLAGS2 = $(HOST_CFLAGS) $(USER_INCLUDES) $(OS_INCLUDES) -D__AROS__

X11KEYMAPTABLE_FILE := $(DEVSDIR)/Keymaps/X11/keycode2rawkey.table

FILES	   := x11 support x11gfx onbitmap offbitmap x11_init support x11kbd x11mouse

OBJDIR := $(GENDIR)/$(CURDIR)
END_FILE := $(OBJDIR)/endtag
ENDFUNC := $(END_FILE).o
OBJS	:= $(foreach f,$(FILES),$(OBJDIR)/$(f).o) $(ENDFUNC) $(OBJDIR)/functable.o $(OBJDIR)/xshm.o
LIB	:= $(LIBDIR)/libx11cl.a
KOBJ    := $(KOBJSDIR)/x11gfx_hidd.o

#MM hidd-graphics-linklib-quick
hidd-graphics-linklib-quick : $(LIB)

#MM
hidd-graphics-x11 : $(LIB) setup

#MM
kernel-x11gfx-kobj : $(KOBJ)

$(LIB) : $(OBJS)
	%mklib_q

$(KOBJ) : $(OBJS)
	echo Linking $@
	@$(LD) -r -o $@ $^

#MM
clean ::
	$(RM) $(OBJS) $(LIB) $(OBJDIR) libdefs.h *.err

#MM
setup :
	%mkdirs_q $(OBJDIR)

#MM x11keymaptable
x11keymaptable : setup-x11keymaptable $(TOOLDIR)/makexkeytable $(X11KEYMAPTABLE_FILE)
	@$(NOP)

#MM change-x11keymaptable
change-x11keymaptable : setup-x11keymaptable $(TOOLDIR)/makexkeytable
	$(TOOLDIR)/makexkeytable -o $(X11KEYMAPTABLE_FILE)

#MM default-x11keymaptable
default-x11keymaptable : setup-x11keymaptable
	@$(CP) def-x11-keycode2rawkey.table $(X11KEYMAPTABLE_FILE)

#MM backup-x11keymaptable
backup-x11keymaptable :
	@$(IF) $(TEST) -f $(X11KEYMAPTABLE_FILE) ; then \
	    $(CP) $(X11KEYMAPTABLE_FILE) ~/aros-x11-keycode2rawkey.table ; \
	    $(ECHO) "" ; \
	    $(ECHO) "Made backup of x11 keymaptable to \"~/aros-x11-keycode2rawkey.table\"" ; \
	    $(ECHO) "" ; \
	else \
	    $(ECHO) "There is no x11 keymaptable existing (\"$(X11KEYMAPTABLE_FILE)\")!?" ; \
	fi

#MM restore-x11keymaptable
restore-x11keymaptable : setup-x11keymaptable
	@$(IF) $(TEST) -f ~/aros-x11-keycode2rawkey.table ; then \
	    $(CP) ~/aros-x11-keycode2rawkey.table $(X11KEYMAPTABLE_FILE) ; \
	    $(ECHO) "" ; \
	    $(ECHO) "Restored x11 keymaptable from \"~/aros-x11-keycode2rawkey.table\"" ; \
	    $(ECHO) "" ; \
	else \
	    $(ECHO) "There is no x11 keymaptable backup existing (\"~/aros-x11-keycode2rawkey.table\")!?" ; \
	fi
	
$(X11KEYMAPTABLE_FILE) :
	$(TOOLDIR)/makexkeytable -o $(X11KEYMAPTABLE_FILE)
	
setup-x11keymaptable :
	%mkdirs_q $(DEVSDIR)/Keymaps $(DEVSDIR)/Keymaps/X11
		
$(TOOLDIR)/makexkeytable: makexkeytable.c
	$(HOST_CC) $(GUI_CCFLAGS) -I$(GUI_INCDIR) $(GUI_LDFLAGS) -lX11 $< -o $@ 

$(OBJDIR)/%.o : %.c
	%compile_q cmd=$(HOST_CC) opt="$(SHARED_CFLAGS) $(CFLAGS2)"

$(OBJDIR)/%.d : %.c
	%mkdepend_q
	
$(OBJDIR)/xshm.o	: xshm.c
	%compile_q cmd=$(HOST_CC) opt="$(SHARED_CFLAGS) $(XSHM_INCLUDES) $(CFLAGS2)"
	
%libdefs_rule
	
%mkfunctable_arch

%mkendtag_q
	
x11gfx_init.o : libdefs.h


%common
%include_deps $(foreach f,$(FILES),$(OBJDIR)/$(f).d) $(END_FILE).d
